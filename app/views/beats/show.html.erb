<script src="https://cdn.jsdelivr.net/gh/phinajs/phina.js@v0.2.3/build/phina.js"></script>
<%# ä¸‹è¨˜ã¯æŠ€è¡“é¢è«‡ã§å¯¾å¿œã‚’ç¢ºèªã™ã‚‹ã€‚notionã«è©³ç´°ã‚ã‚Šã€‚ %>
<%# javascript_pack_tag 'phina', 'data-turbolinks-track': 'reload' %>

<script>
  if (!phina.util.Support.webAudio) {
    alert('webAudioã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼æœ€æ–°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä½¿ã£ã¦ä¸‹ã•ã„ï¼');
  }

  phina.globalize();

var MARKER_RADIUS = 80; //ãƒãƒ¼ãƒ„ã®å¤§ãã•
var MARKER_STROKE_WIDTH = 8; //ãƒãƒ¼ãƒ„ã®å¹…
var MARKER_APPEARANCE_DELTA = 4000; // ãƒãƒ¼ãƒ„å‡ºç¾æ™‚é–“(ms): å¤§ããã™ã‚‹ã»ã©ä½é€Ÿ
var MUSIC_START_DELAY = 2000; // é–‹å§‹ã€œç§’å¾Œã«éŸ³æ¥½ã‚¹ã‚¿ãƒ¼ãƒˆ

var RATING_TABLE = {
  perfect: {
    score: 1000,
    range: 50, //ms
  },
  great: {
    score: 500,
    range: 120, //ms
  },
  good: {
    score: 100,
    range: 265, //ms
  },
  miss: {
    score: 0,
    range: 310, //ms
  },
};


var ASSETS = {
  sound: {
    music: "<%= asset_path("lightItUp.mp3") %>", //ãƒ‡ãƒãƒƒã‚°ç”¨
    // music: "<%= @beat.music.url %>", //æœ¬ç•ªç”¨
    ring: "<%= asset_path("kick052.mp3") %>",
  },
  json: {
    beatmap: "<%= asset_path("notes.json") %>" //ãƒ‡ãƒãƒƒã‚°ç”¨
    // beatmap: "<%= @beat.notes.url %>" //æœ¬ç•ªç”¨
  },
  image: {
    'bg': "<%= asset_path("club.png") %>",
    'bg2': "<%= asset_path("dj.png") %>",
    'sprite': "<%= @beat.gif.url %>",
  },
    // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆ
  spritesheet: {
    "sprite_ss":
    {
      // ãƒ•ãƒ¬ãƒ¼ãƒ æƒ…å ±
      "frame": {
        "width": 750, // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã®ç”»åƒã‚µã‚¤ã‚ºï¼ˆæ¨ªï¼‰
        "height": 1334, // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã®ç”»åƒã‚µã‚¤ã‚ºï¼ˆç¸¦ï¼‰
        "cols": 1, // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ï¼ˆæ¨ªï¼‰
        "rows": 28, // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ï¼ˆç¸¦ï¼‰
      },
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±
      "animations" : {
        "squat": { // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å
          "frames": [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27], // ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·ç¯„å›²
          "next": "squat", // æ¬¡ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          "frequency": 6, // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–“éš”
        },
      }
    },
  }
};


phina.define('LoadingScene', {
  superClass: 'DisplayScene',

  init: function(options) {
    this.superInit(options);
    var self = this;

    // view
    var baseLayer = DisplayElement(options).addChildTo(this);

    // ãƒ©ãƒ™ãƒ«
    var label = Label({
      text: "NOW LOADING...",
      fill: "#fff",
      fontFamily: 'Rowdies',
    })
    .addChildTo(baseLayer)
    .setPosition(this.width*0.7, this.height*0.5)
    .setRotation(90)
    label.tweener.clear()
    .setLoop(1)
    .to({alpha:0}, 500)
    .to({alpha:1}, 500)
    ;

    // ãã‚‹ãã‚‹ã¾ã‚ã‚‹å††
    var circle = phina.display.CircleShape({
      stroke: "#ff00de",
      fill: false,
      radius: 100,
      strokeWidth: 10,
    })
    .addChildTo(baseLayer)
    .setPosition(this.width*0.5, this.height*0.5)
    .setRotation(90)
    circle.tweener.clear()
    .setLoop(1)
    .to({scaleX: -1}, 900, "easeInOutCubic")
    .to({scaleX: 1}, 900, "easeInOutCubic")
    ;

    // ã‚²ãƒ¼ã‚¸
    var gauge = phina.ui.Gauge({
      value: 0,
      gaugeColor: "#41E564",
    })
    .setPosition(this.width*0.3, this.height*0.5)
    .setRotation(90)
    .addChildTo(baseLayer);
    gauge.animationTime = 5000;


    // ãƒ•ãƒ­ãƒ¼
    var flows = [];

    // ãƒ­ãƒ¼ãƒ€ãƒ¼å‡¦ç†
    var loader = phina.asset.AssetLoader();
    var loaderFlow = phina.util.Flow(function(resolve) {

      // é€²è¡Œ
      loader.onprogress = function(e) {
        gauge.value = e.progress * 80;
      };

      // ãƒ­ãƒ¼ãƒ‰å®Œäº†
      loader.onload = function() {
        resolve("loader loaded!");
      };
    });
    flows.push(loaderFlow);
    loader.load(options.assets);

    // æ™‚é–“ç¨¼ãç”¨ã®ä»®å‡¦ç†
    var otherFlow = phina.util.Flow(function(resolve) {
      setTimeout(function() {
        resolve("owari!");
      }, 3000)
    });
    flows.push(otherFlow);

    // å…¨ã¦çµ‚ã‚ã£ãŸã‚‰
    phina.util.Flow.all(flows).then(function(args) {

      //ã‚²ãƒ¼ã‚¸å³åº§ã«100ï¼…ã«
      gauge.animationTime = 1;
      gauge.value = 100;

      // ãã‚‹ãã‚‹æ­¢ã‚ã‚‹
      circle.stroke = "#2BF439";
      circle.tweener.clear()
      .to({scaleX: 1}, 350)

      label.text = "LOAD COMPLETE";
      label.tweener.clear()
      .to({alpha:0}, 100)
      .to({alpha:1}, 100)
      .to({alpha:0}, 100)
      .to({alpha:1}, 100)
      .to({alpha:0}, 100)
      .to({alpha:1}, 100)
      .wait(750)
      .call(function() {
        baseLayer.tweener.clear()
        .by({alpha: -1, x:70}, 300, 'easeInQuad')
        .wait(300)
        .call(function() {
          self.flare('loaded');
        })
      })
      ;
    });
  },
});


/**
 * ã‚¿ã‚¤ãƒˆãƒ«
 */
phina.define('TitleScene', {
  superClass: 'phina.display.DisplayScene',

  init: function(params) {
    this.superInit(params);
    this.backgroundColor = params.backgroundColor;
    Sprite('bg').addChildTo(this)
            .setPosition(this.gridX.center(), this.gridY.center());


    // ã‚¿ã‚¤ãƒˆãƒ«ãƒ©ãƒ™ãƒ«
    Label({
      text: "<%= @beat.title %>",
      fill: "white",
      stroke: "#2F3CEC",
      strokeWidth: 6,
      fontFamily: 'Rowdies',
      fontSize: 200,
      shadow: "magenta",
      shadowBlur: 50,
    })
    .setPosition(this.gridX.span(10), this.gridY.center())
    .setRotation(90)
    .addChildTo(this)

    var touchLabel = Label({
      text: "ã‚¿ãƒƒãƒ—ã§START",
      fill: "white",
      stroke: "#2F3CEC",
      strokeWidth: 6,
      fontFamily: 'Rowdies',
      fontWeight: 'bold',
      fontSize: 84,
    })
    .setPosition(this.gridX.span(4), this.gridY.center())
    .setRotation(90)
    .addChildTo(this);

    // æ˜æ»…ã•ã›ã‚‹
    touchLabel.tweener.clear()
    .setLoop(true)
    .to({alpha: 0}, 700)
    .to({alpha: 1}, 700)
    ;

    // ãƒ¢ãƒã‚¤ãƒ«ã§ã®å†ç”Ÿåˆ¶é™ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã®ãŸã‚ã€ç”»é¢ã‚¿ãƒƒãƒæ™‚ã«Soundã‚’ç„¡éŸ³å†ç”Ÿ
    this.on('enter', function() {
      var event = "touchstart";
      var dom = this.app.domElement;
      dom.addEventListener(event, (function() {
        return function f() {
          var context = phina.asset.Sound.getAudioContext();
          var buf = context.createBuffer(1, 1, 22050);
          var src = context.createBufferSource();
          src.buffer = buf;
          src.connect(context.destination);
          src.start(0);

          dom.removeEventListener(event, f, false);
        }
      }()), false);

      // ã‚·ãƒ¼ãƒ³é·ç§»
      this.on('pointend', function() {
        this.exit();
      });
    });
  },
});


/**
 * ã‚¹ã‚³ã‚¢ãƒšãƒ¼ã‚¸
 */
phina.define('ScoreScene', {
  superClass: 'phina.display.DisplayScene',

  init: function(params) {
    this.superInit(params);
    this.backgroundColor = params.backgroundColor;
    Sprite('bg').addChildTo(this)
            .setPosition(this.gridX.center(), this.gridY.center());
    var gameScore = params.score

    // ã‚¿ã‚¤ãƒˆãƒ«ãƒ©ãƒ™ãƒ«
    Label({
      text: "Score",
      fill: "white",
      stroke: "#2F3CEC",
      strokeWidth: 6,
      fontSize: 94,
      fontFamily: 'Rowdies',
    })
    .setPosition(this.gridX.span(12), this.gridY.center())
    .setRotation(90)
    .addChildTo(this)

    Label({
      text: gameScore,
      fill: "white",
      stroke: "#2F3CEC",
      strokeWidth: 6,
      fontSize: 230,
      fontFamily: 'Rowdies',
      shadow: "magenta",
      shadowBlur: 50,
    })
    .setPosition(this.gridX.span(8.5), this.gridY.center())
    .setRotation(90)
    .addChildTo(this)


    // ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³
    var homeButton = phina.ui.Button({
      text: 'Home',
      fontSize: 74,
      fontFamily: 'Rowdies',
      fontWeight: 'bold',
      width: 300,
      height: 100,
      shadow: "white",
      shadowBlur: 10,
      fill: 'magenta',
    })
    .setPosition(this.gridX.span(2.5), this.gridY.center())
    .setRotation(90)
    .addChildTo(this);

    // ã‚·ãƒ¼ãƒ³é·ç§»ï¼ˆãƒ“ãƒ¼ãƒˆä¸€è¦§ã¸é·ç§»ï¼‰
    homeButton.onclick = function(){
      window.location.href = '/beats';
    };


    // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
    var shareButton = phina.ui.Button({
      text: 'Twitter ShareğŸ•Š',
      fontSize: 74,
      fontFamily: 'Rowdies',
      fontWeight: 'bold',
      width: 660,
      height: 100,
      shadow: "white",
      shadowBlur: 3,
    })
    .setPosition(this.gridX.span(4.5), this.gridY.center())
    .setRotation(90)
    .addChildTo(this);

    var params = {
      score: params.score,
      // hashtags: [""]
    };

    // ã‚¯ãƒªãƒƒã‚¯å‹•ä½œ
    shareButton.onclick = function(){
      var text = 'ãƒŠã‚¤ã‚¹ãƒ“ãƒ¼ãƒˆãƒƒï¼ï¼ï¼\nScore: {0}\n{1}\n'.format(params.score);
      var url = phina.social.Twitter.createURL({
        text: text,
        hashtags: 'MuscleBeat',
        url: 'http://muscle-beat.herokuapp.com',
      });
      window.open(url, 'share window', 'width=480, height=320');
      // ç”»é¢é·ç§»
      window.location.href = '/beats';
    };

    // ãƒ‡ãƒãƒƒã‚°ç”¨
    this.onpointstart = function() {
      // ResultSceneã¸
      this.exit();
    };

  },
});


/*
 * ãƒ¦ãƒ‹ãƒƒãƒˆè¡¨ç¤ºã‚¢ã‚¤ã‚³ãƒ³
 */
phina.define('UnitIcon', {
  superClass: 'phina.display.CircleShape',

  init: function(id, label) {
    this.superInit({
      radius: MARKER_RADIUS,
      strokeWidth: MARKER_STROKE_WIDTH,
      stroke: "rgba(127, 255, 255, 1)",
      fill: "rgba(127, 255, 255, 0.4)",
    });
    this.setInteractive(true);
    this.id = id;
  },

  fireEffect: function() {
    EffectWave().addChildTo(this);
  },

});


/**
 * ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚«ãƒ¼ï¼ˆãƒãƒ¼ãƒ„ï¼‰
 */
phina.define('TargetMarker', {
  superClass: 'phina.display.CircleShape',

  init: function(targetTime, trackId, stroke) {
    this.superInit({
      radius: MARKER_RADIUS,
      strokeWidth: MARKER_STROKE_WIDTH,
      stroke: stroke,
      fill: false,
    });

    this.visible = false;
    this.scaleX = this.scaleY = 0;
    this.isAwake = true;

    this.targetTime = targetTime;
    this.trackId = trackId;

    // é€²è¡Œæ–¹å‘ ä¸‹â†’ä¸Š
    this.vector = phina.geom.Vector2(
      Math.cos((270).toRadian()),
      Math.sin((270).toRadian())
    );
  },
});


/**
 * ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šç™½ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå††
 */
phina.define('EffectWave', {
  superClass: 'phina.display.CircleShape',

  init: function(options) {
    this.superInit({
      radius: MARKER_RADIUS,
      stroke: false,
      fill: "white",
    });

    this.tweener
    .to({scaleX:2.3, scaleY:2.3, alpha:0}, 250)
    .call(function() {
      this.remove();
    }, this);
  },
});

/**
 * ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼š"PERFECT!"ãªã©
 */
phina.define('RateLabel', {
  superClass: 'phina.display.Label',

  init: function(textParam, fillParam) {
    this.superInit({
      text: textParam.text,
      fontSize: 90,
      strokeWidth: 7,
      fill: fillParam.fill,
      stroke: "white",
      fontFamily: 'Rowdies',
      shadow: "white",
      shadowBlur: 50,
    });

    this.tweener
    .set({scaleX: 0.2, scaleY: 0.2, alpha: 0})
    .to({scaleX:1, scaleY:1, alpha:1}, 130, "easeOutCirc")
    .wait(250)
    .to({alpha:0}, 100)
    .call(function() {
      this.remove();
    }, this);
  },
});

/**
 * ãƒ¡ã‚¤ãƒ³
 */
phina.define('MainScene', {
  superClass: 'DisplayScene',

  init: function(options) {
    this.superInit(options);
    this.backgroundColor = "navy";
    // èƒŒæ™¯
    Sprite('bg2').addChildTo(this)
                .setPosition(this.gridX.center(), this.gridY.center());

    var self = this;
    var gx = this.gridX;
    var gy = this.gridY;
    var AM = phina.asset.AssetManager;

    var beatmap = AM.get('json', 'beatmap').data;

    // ã‚¿ã‚¤ãƒãƒ¼ã®ã‚»ãƒƒãƒˆ
    this.elapsedTime = 0; // çµŒéæ™‚é–“
    this.gameTime = 0 - MUSIC_START_DELAY + beatmap.offset; // åˆ¤å®šç”¨æ™‚é–“

    this.totalScore = 0;

    // æ™‚é–“ãŒæ¥ãŸã‚‰éŸ³æ¥½æµã™
    this.one('musicstart', function() {
      SoundManager.playMusic('music', null, false);
    });

    // ãƒ¦ãƒ‹ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®é…ç½®ï¼ˆãƒãƒ¼ãƒ„ã®å‡ºç™ºåœ°ç‚¹ï¼‰
    var iconGroup = DisplayElement()
    .setPosition(gx.center(-5), gy.span(16.5))
    .addChildTo(this);

    // ã‚¿ãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã®é…ç½®ï¼ˆï¼™å€‹ï¼‰â†’ï¼‘å€‹ã«å¤‰æ›´
    var icon = UnitIcon(0)
    .setPosition(
      gx.center(-8),
      gy.span(-14.5),
    )
    .addChildTo(iconGroup);

    // åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆ©ç”¨ã—ãŸåˆ¤å®šæ©Ÿèƒ½
    window.addEventListener("devicemotion", function (event) {
      // åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®å€¤ã‚’å¤‰æ•°ã«æ ¼ç´
      var x = Math.floor(event.accelerationIncludingGravity.x)
      var y = Math.floor(event.accelerationIncludingGravity.y)
      var z = Math.floor(event.accelerationIncludingGravity.z)

      if (Math.abs(x) > 15 || Math.abs(y) > 15 || Math.abs(z) > 15) {
        self.judge(icon);
      }
    })


    // ã‚¿ãƒƒãƒ—ãƒ»ã‚¯ãƒªãƒƒã‚¯åˆ¤å®š
    icon.onpointstart = function() {
      self.judge(this); // è‡ªåˆ†ã‚’æ¸¡ã™
    };

    // ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ãƒ»ã‚¯ãƒªãƒƒã‚¯ã§åˆ¤å®š
    this.on('pointend', function() {
      self.judge(icon);
    });


    // è­œé¢ã®å±•é–‹
    this.markerGroup = DisplayElement()
    .setPosition(iconGroup.x, iconGroup.y)
    .addChildTo(this);
    beatmap.notes.forEach(function(note) {
      TargetMarker(note.targetTime, 0, note.stroke)
      .addChildTo(self.markerGroup)
    })

    // scoreè¡¨ç¤º
    this.scoreLabel = Label({
      text: 0,
      textAlign: "center",
      stroke: "magenta",
      fill: "white",
      strokeWidth: 4,
      fontSize: 65,
      fontFamily: 'Rowdies',
    })
    .setPosition(gx.span(13), gy.center())
    .setRotation(90)
    .addChildTo(this)
    .on('enterframe', function() {
      this.text = self.totalScore;
    });


    // ç­‹ãƒˆãƒ¬èª¬æ˜æ–‡ã®è¡¨ç¤º
    this.descriptionLabel = Label({
      text: ["<%= @beat.training_description %>"],
      textAlign: "center",
      fill: "white",
      backgroundColor: "rgba(0, 0, 0, 0.5)",
      strokeWidth: 2,
      fontSize: 42,
      fontWeight: 'bold',
      lineHeight: 1.5,
      padding: 12,
    })
    .setPosition(gx.span(12), gy.center(4.5))
    .setRotation(90)
    .addChildTo(this)


    // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒä½œæˆ
    var sprite = Sprite('sprite', 750, 1334)
    .setPosition(gx.span(11.5), gy.center(-4.5))
    .setScale(0.5, 0.5)
    .setRotation(90)
    .addChildTo(this);
    // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã«ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¢ã‚¿ãƒƒãƒ
    var anim = FrameAnimation('sprite_ss').attachTo(sprite);
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹
    anim.gotoAndPlay('squat');
  },


  update: function(app) {
    var self = this;
    var ps = app.pointers;
    var kb = app.keyboard;

    // ã‚¿ã‚¤ãƒãƒ¼åŠ ç®—
    this.elapsedTime += app.deltaTime;
    this.gameTime += app.deltaTime;

    // ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã¾ã§ã®çŒ¶äºˆ
    if (this.has('musicstart') && this.elapsedTime > MUSIC_START_DELAY) {
      this.flare('musicstart');
    }

    // ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ˆScoreãƒšãƒ¼ã‚¸ã¸ï¼‰
    if (this.elapsedTime > "<%= @beat.url%>") {
      SoundManager.stopMusic();

      // ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—
      const data = { score: this.totalScore, user_id: "<%= current_user.id if logged_in? %>", beat_id: "<%= @beat.id %>" }
      axios.post('/scores', data);

      self.exit({score: this.totalScore,});
    };

    // ãƒãƒ¼ãƒ„æç”»
    var markers = this.markerGroup.children;
    markers.forEach(function(m) {
      if (!m.isAwake) return;

      var time = this.gameTime
      var rTime = m.targetTime - time; // ç›¸å¯¾æ™‚é–“

      if (rTime < MARKER_APPEARANCE_DELTA) {
        // ãƒãƒ¼ãƒ„ã®ä½ç½®æ¯”ç‡ã‚„ç¸®å°ç‡ï¼ˆå€ç‡ï¼‰ã‚’è¨ˆç®—ã™ã‚‹
        // ratioã¯ã‚¢ã‚¤ã‚³ãƒ³ã«è¿‘ã„ã»ã©1.0ã«è¿‘ã¥ã
        var ratio = (time - (m.targetTime - MARKER_APPEARANCE_DELTA)) / MARKER_APPEARANCE_DELTA;
        var distance = 1360 * ratio; // ãƒãƒ¼ãƒ„ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯

        m.setVisible(true)
        .setPosition(
          m.vector.x * distance,
          m.vector.y * distance
        )
        // ãƒãƒ¼ãƒ„ã®å¤§ãã•ï¼ˆç¸®å°ç‡ï¼‰
        .setScale(1, 1);
      }

      // missåˆ¤å®š
      if (RATING_TABLE["miss"].range < -rTime) {
        this.reaction(m, "miss");
      }
    }.bind(this));

  },

  // åˆ¤å®šå‡¦ç†
  judge: function(unitIcon) {
    var time = this.gameTime;

    // åˆ¤å®šå¯èƒ½ãƒãƒ¼ãƒ„ã‚’æ¢ç´¢
    var markers = this.markerGroup.children;
    markers.some(function(m) {
      if (!m.isAwake || m.trackId !== unitIcon.id) return;

      // ãƒãƒ¼ãƒ„ãŒæœ‰åŠ¹ã‹ã¤trackIdãŒä¸€è‡´ã€ã‹ã¤åˆ¤å®šç¯„å›²å†…
      // åˆ¤å®šãŒç‹­ã„é †ã«åˆ¤å®šã—ã€è©²å½“ã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—æ‹”ã‘ã‚‹
      var delta = Math.abs(m.targetTime - time);
      if (delta <= RATING_TABLE["perfect"].range) {
        unitIcon.fireEffect();
        SoundManager.play('ring');
        this.reaction(m, "perfect");
        return true;
      }
      if (delta <= RATING_TABLE["great"].range) {
        unitIcon.fireEffect();
        SoundManager.play('ring');
        this.reaction(m, "great");
        return true;
      }
      if (delta <= RATING_TABLE["good"].range) {
        unitIcon.fireEffect();
        SoundManager.play('ring');
        this.reaction(m, "good");
        return true;
      }
      if (delta <= RATING_TABLE["miss"].range) {
        this.reaction(m, "miss");
        return true;
      }
    }.bind(this));

  },

  reaction: function(marker, rating) {
    // ãƒãƒ¼ãƒ„ä¸å¯è¦–åŒ–
    marker.isAwake = false;
    marker.visible = false;

    if (rating == "perfect") {
      RateLabel({text: rating.toUpperCase()},{fill: "magenta"})
      .setPosition(this.gridX.center(), this.gridY.center())
      .setRotation(90)
      .addChildTo(this);
    }
    if (rating == "great") {
      RateLabel({text: rating.toUpperCase()},{fill: "lime"})
      .setPosition(this.gridX.center(), this.gridY.center())
      .setRotation(90)
      .addChildTo(this);
    }
    if (rating == "good") {
      RateLabel({text: rating.toUpperCase()},{fill: "blue"})
      .setPosition(this.gridX.center(), this.gridY.center())
      .setRotation(90)
      .addChildTo(this);
    }
    if (rating == "miss") {
      RateLabel({text: rating.toUpperCase()},{fill: "dimgray"})
      .setPosition(this.gridX.center(), this.gridY.center())
      .setRotation(90)
      .addChildTo(this);
    }

    this.totalScore += RATING_TABLE[rating].score;
  },

});


  phina.main(function() {
    var app = GameApp({
      assets: ASSETS,
      width: 1030,
      height: 1500,
      startLabel: 'TitleScene',
      backgroundColor: 'navy',
      title: 'ã‚µãƒ³ãƒ—ãƒ«',
      fps: 60,

      scenes: [
        {
          className: 'TitleScene',
          label: 'TitleScene',
          nextLabel: 'MainScene',
        },
        {
          className: 'MainScene',
          label: 'MainScene',
          nextLabel: 'ScoreScene',
        },
        {
          className: 'ScoreScene',
          label: 'ScoreScene',
          nextLabel: 'TitleScene',
        },
      ]
    });

    app.run();
  });


</script>
